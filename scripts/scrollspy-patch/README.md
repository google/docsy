# ScrollSpy Patch Scripts

This directory contains scripts for creating a runtime patch of the Bootstrap
ScrollSpy method `_initializeTargetsAndObservables()`. We will refer to this
method as the METHOD.

## Files

- `node_modules/bootstrap/js/src/scrollspy.js`: the SOURCE_FILE containing the
  METHOD to be patched.
- `assets/js/scrollspy-patch.js`: code that patches the METHOD at runtime
  (RUNTIME_PATCHER_JS). Everything described here is in support of creating this
  file from the original Bootstrap SOURCE_FILE.

Intermediate files used to simplify the process of creating the
RUNTIME_PATCHER_JS file, and detecting when the METHOD code has changed:

- `assets/_cache/bootstrap/scrollspy-method.js`: the METHOD function source
  extracted from SOURCE_FILE (METHOD_SOURCE_FILE)
- `assets/_cache/bootstrap/method.patch`: standard patch used to create our
  patched METHOD code; it is in standard unified diff format (generated by
  `diff -u` and applied by the standard `patch` command).
- `assets/_cache/bootstrap/scrollspy-method-patched.js` - the METHOD function
  patched.

## Scripts

- `extract-method.pl` - Extracts the METHOD from SOURCE_FILE and saves it to the
  METHOD_SOURCE_FILE file.
- `apply-patch.sh` - Applies the patch using the standard `patch` command and
  saves the patched method to `scrollspy-method-patched.js`
- `update-patch-js.pl` - Updates `assets/js/scrollspy-patch.js` with the patched
  method from `scrollspy-method-patched.js`

The patch file `method.patch` is stored in `assets/_cache/bootstrap/` alongside
the cached method file.

## Workflow

### Automated (CI/CD)

The `_prepare:scrollspy-patch` script (called by `_prepare`) automatically:

1. Extracts the method from Bootstrap (`_cp:bs-scrollspy`) - writes to
   `assets/_cache/bootstrap/scrollspy-method.js`
2. Applies the patch (`apply-patch.sh`) - writes patched method to
   `assets/_cache/bootstrap/scrollspy-method-patched.js`
3. Updates `assets/js/scrollspy-patch.js` (`update-patch-js.pl`) - syncs the
   patched method body into the runtime patch file

The `ci:prepare` script calls `_prepare` and `_diff:check` to ensure no
unexpected changes occurred. If the cached method source, patched result, or
`scrollspy-patch.js` differs from what's committed, CI will fail, indicating
review is needed.

### Manual Steps

When Bootstrap is updated:

- Run `npm run ci:prepare` to ensure that the patch file and runtime patch code
  are up to date. If the command fails, review the changes and update the patch
  file manually, as described below.

### Updating the patch file manually

When the METHOD code has changed:

- Review the METHOD code changes.
- Manually update `scrollspy-method-patched.js` to reflect the changes while
  preserving the purpose of the code patch.
- Manually regenerate the patch file by running:

  ```bash
  cd assets/_cache/bootstrap &&
  diff -u scrollspy-method.js scrollspy-method-patched.js > method.patch
  ```

- Rerun `npm run ci:prepare` to ensure that the updated patch file works, and to
  update RUNTIME_PATCHER_JS.
- Commit changes.
