{{/*

  FIXME: The $safeIds functionality is a temporary workaround for the ScrollSpy
  bug described in https://github.com/google/docsy/issues/2329. For details,
  also see https://www.docsy.dev/blog/2025/0.13.0.

  Always render the dev.td-toc element. ScrollSpy is counting on it to exist,
  even if it's empty.

  cSpell:ignore notoc
*/ -}}

<div class="td-toc" data-proofer-ignore>
{{ if not .Params.notoc -}}
  {{ $toc := .TableOfContents -}}
  {{ if and $toc (ne $toc `<nav id="TableOfContents"></nav>`) -}}
    {{ $scrollSpyEnabled := not (.Param "ui.scrollSpy.disable") -}}
    {{ $safeIds := .Param "ui.scrollSpy.safeIds" | default $scrollSpyEnabled -}}
    <div class="td-toc__title">
      <span class="td-toc__title__text">On this page</span>
      <a class="td-toc__title__link" title="Top of page" href="#"></a>
    </div>
    {{ if $safeIds -}}
      {{/* Adjust any href values that start with a digit by adding a prefixing */ -}}
      {{ $toc = replaceRE `(href="#)([0-9])` "${1}_toc_id_patch_$2" $toc -}}
    {{ else if $scrollSpyEnabled -}}
      {{ with findRE `href="#[0-9][^"]*"` . -}}
        {{ $msg := slice
          (printf "%s: TOC contains href that may cause ScrollSpy to fail: %s." .File.Filename .)
          "For details, see https://www.docsy.dev/blog/2025/0.13.0/."
        -}}
        {{ warnidf "scrollspy-toc-href" "[Docsy] %s" (delimit $msg " ") -}}
      {{ end -}}
    {{ end -}}
    {{ $toc | safeHTML }}
  {{ end -}}
{{ end -}}
</div>
{{/* */ -}}
