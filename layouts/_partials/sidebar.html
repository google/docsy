{{/* The "active" toggle here may delay rendering, so we only cache this side bar menu for bigger sites. */ -}}

{{ $sidebarCacheLimit := .Site.Params.ui.sidebar_cache_limit | default 2000 -}}
{{ $cacheSidebar := ge (len .Site.Pages) $sidebarCacheLimit -}}

{{/* Determine sidebar root and ID (if enabled) */ -}}
{{ $sidebarRoot := .FirstSection -}}
{{ $navRoot := cond (and (ne .Params.toc_root true) (eq .Site.Home.Type "docs")) .Site.Home .FirstSection -}}
{{ if .Site.Params.ui.sidebar_root_enabled -}}
  {{ range .Ancestors.Reverse -}}
    {{ if not (and .IsSection .Params.sidebar_root) -}}
      {{ continue -}}
    {{ end -}}
    {{ $sidebarRoot = . -}}
    {{/* Warn if sidebar_root is set on a top-level section */ -}}
    {{ if or (eq . $.Site.Home) (eq . $navRoot) -}}
      {{ warnf "sidebar_root is set on a top-level section (%s). This parameter is intended for nested sections only." .Path -}}
    {{ end -}}
  {{ end -}}
{{ end -}}
{{ $sidebarRootID := $sidebarRoot.RelPermalink -}}
{{ $args := dict
    "context" .
    "cacheSidebar" $cacheSidebar
    "sidebarRoot" $sidebarRoot
    "sidebarRootID" $sidebarRootID
-}}
{{ if $cacheSidebar -}}
  {{ $mid := printf "m-%s" (.RelPermalink | anchorize) }}
  <script>
    $(function() {
    $("#td-section-nav a").removeClass("active");
    $("#td-section-nav #{{ $mid }}").addClass("active");
    $("#td-section-nav #{{ $mid }}-li span").addClass("td-sidebar-nav-active-item");
    $("#td-section-nav #{{ $mid }}").parents("li").addClass("active-path");
    $("#td-section-nav li.active-path").addClass("show");
    $("#td-section-nav li.active-path").children("input").prop('checked', true);
    $("#td-section-nav #{{ $mid }}-li").siblings("li").addClass("show");
    $("#td-section-nav #{{ $mid }}-li").children("ul").children("li").addClass("show");
    $("#td-sidebar-menu").toggleClass("d-none");
    });
  </script>
  {{ partialCached "sidebar-tree.html" $args $sidebarRootID }}
{{ else -}}
  {{ partial "sidebar-tree.html" $args }}
{{- end }}